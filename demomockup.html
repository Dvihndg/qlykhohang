<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart WMS - Hệ Thống Quản Lý Kho Thông Minh</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #F8FAFC; color: #334155; }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .glass-effect { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
        .sidebar-item.active { background-color: #EFF6FF; color: #2563EB; border-right: 3px solid #2563EB; }
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Mobile Mockup Styles */
        .phone-frame {
            border: 14px solid #1e293b;
            border-radius: 2rem;
            overflow: hidden;
            position: relative;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            background: #fff;
        }
        .phone-notch {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 40%;
            height: 24px;
            background: #1e293b;
            border-bottom-left-radius: 12px;
            border-bottom-right-radius: 12px;
            z-index: 50;
        }
        .scan-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background: #ef4444;
            box-shadow: 0 0 4px #ef4444;
            animation: scan 2s infinite linear;
        }
        @keyframes scan {
            0% { top: 10%; opacity: 0; }
            50% { opacity: 1; }
            100% { top: 90%; opacity: 0; }
        }
        /* AI Chat Bubble */
        .chat-bubble {
            max-width: 80%;
            padding: 10px 15px;
            border-radius: 15px;
            font-size: 0.9rem;
            line-height: 1.4;
            margin-bottom: 10px;
        }
        .chat-user {
            background-color: #2563EB;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 2px;
        }
        .chat-ai {
            background-color: #F1F5F9;
            color: #334155;
            align-self: flex-start;
            border-bottom-left-radius: 2px;
            border: 1px solid #E2E8F0;
        }
    </style>
</head>
<body class="h-screen flex overflow-hidden bg-slate-50">

    <!-- SIDEBAR -->
    <aside class="w-64 bg-white border-r border-gray-200 flex flex-col z-20 hidden md:flex shadow-sm">
        <div class="h-16 flex items-center px-6 border-b border-gray-100">
            <i class="fas fa-cube text-blue-600 text-2xl mr-3"></i>
            <span class="font-bold text-xl text-gray-800 tracking-tight">Smart WMS</span>
        </div>

        <nav class="flex-1 py-6 space-y-1">
            <a href="#" onclick="switchPage('dashboard')" id="nav-dashboard" class="sidebar-item active flex items-center px-6 py-3 text-gray-600 hover:bg-gray-50 hover:text-blue-600 transition-colors">
                <i class="fas fa-chart-pie w-6"></i>
                <span class="font-medium">Tổng Quan (Dashboard)</span>
            </a>
            <a href="#" onclick="switchPage('inventory')" id="nav-inventory" class="sidebar-item flex items-center px-6 py-3 text-gray-600 hover:bg-gray-50 hover:text-blue-600 transition-colors">
                <i class="fas fa-boxes w-6"></i>
                <span class="font-medium">Quản Lý Kho Hàng</span>
            </a>
            <a href="#" onclick="switchPage('operations')" id="nav-operations" class="sidebar-item flex items-center px-6 py-3 text-gray-600 hover:bg-gray-50 hover:text-blue-600 transition-colors">
                <i class="fas fa-exchange-alt w-6"></i>
                <span class="font-medium">Nhập / Xuất Kho</span>
            </a>
            <a href="#" onclick="switchPage('ai-features')" id="nav-ai-features" class="sidebar-item flex items-center px-6 py-3 text-gray-600 hover:bg-purple-50 hover:text-purple-600 transition-colors">
                <i class="fas fa-brain w-6"></i>
                <span class="font-medium">AI & Mở Rộng <span class="text-xs bg-gradient-to-r from-purple-500 to-pink-500 text-white px-2 py-0.5 rounded-full ml-1 animate-pulse">Gemini</span></span>
            </a>
        </nav>

        <div class="p-4 border-t border-gray-100">
            <!-- Mobile App Launcher -->
            <button onclick="toggleMobileModal()" class="w-full bg-gradient-to-r from-blue-600 to-indigo-600 text-white p-3 rounded-lg shadow-md flex items-center justify-center gap-2 mb-4 hover:shadow-lg transition-all transform hover:-translate-y-1">
                <i class="fas fa-qrcode"></i>
                <span class="font-bold text-sm">Mở App Mobile / Quét QR</span>
            </button>
            
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold">A</div>
                <div>
                    <p class="text-sm font-medium text-gray-700">Admin User</p>
                    <p class="text-xs text-gray-500">Kho Thái Nguyên</p>
                </div>
            </div>
        </div>
    </aside>

    <!-- MOBILE HEADER -->
    <div class="md:hidden fixed w-full bg-white border-b z-30 flex justify-between items-center px-4 h-16">
        <span class="font-bold text-xl text-blue-600">Smart WMS</span>
        <div class="flex items-center gap-3">
            <button onclick="toggleMobileModal()" class="text-blue-600 bg-blue-50 p-2 rounded-full"><i class="fas fa-qrcode"></i></button>
            <button onclick="document.querySelector('aside').classList.toggle('hidden'); document.querySelector('aside').classList.toggle('absolute'); document.querySelector('aside').classList.toggle('h-full');" class="text-gray-600"><i class="fas fa-bars text-xl"></i></button>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <main class="flex-1 overflow-y-auto p-4 md:p-8 pt-20 md:pt-8 bg-slate-50 relative">
        
        <!-- PAGE: DASHBOARD -->
        <div id="page-dashboard" class="page-content animate-fade-in block">
            <div class="flex justify-between items-end mb-8">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800">Dashboard Tổng Quan</h2>
                    <p class="text-gray-500 text-sm mt-1">Cập nhật thời gian thực lúc: <span id="current-time">--:--</span></p>
                </div>
                <button onclick="refreshData()" class="text-blue-600 hover:text-blue-700 text-sm font-medium"><i class="fas fa-sync-alt mr-1"></i> Làm mới</button>
            </div>

            <!-- KPI Cards -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm font-medium text-slate-500">Tổng Giá Trị Kho</p>
                            <h3 class="text-2xl font-bold text-slate-800 mt-2" id="kpi-value">0 ₫</h3>
                        </div>
                        <div class="p-3 bg-blue-50 text-blue-600 rounded-lg"><i class="fas fa-dollar-sign"></i></div>
                    </div>
                    <p class="text-xs text-green-500 mt-2 font-medium flex items-center"><i class="fas fa-arrow-up mr-1"></i> +2.5% so với tuần trước</p>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm font-medium text-slate-500">Tổng Số Lượng SP</p>
                            <h3 class="text-2xl font-bold text-slate-800 mt-2" id="kpi-qty">0</h3>
                        </div>
                        <div class="p-3 bg-indigo-50 text-indigo-600 rounded-lg"><i class="fas fa-box"></i></div>
                    </div>
                    <p class="text-xs text-slate-400 mt-2">Đang lưu trữ</p>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm font-medium text-slate-500">Giao Dịch Hôm Nay</p>
                            <h3 class="text-2xl font-bold text-slate-800 mt-2" id="kpi-trans">0</h3>
                        </div>
                        <div class="p-3 bg-green-50 text-green-600 rounded-lg"><i class="fas fa-truck-loading"></i></div>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-red-500">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-sm font-medium text-slate-500">Cảnh Báo Tồn Thấp</p>
                            <h3 class="text-2xl font-bold text-red-600 mt-2" id="kpi-alert">0</h3>
                        </div>
                        <div class="p-3 bg-red-50 text-red-600 rounded-lg animate-pulse"><i class="fas fa-exclamation-triangle"></i></div>
                    </div>
                    <p class="text-xs text-red-500 mt-2 font-medium cursor-pointer hover:underline" onclick="switchPage('inventory')">Xem chi tiết &rarr;</p>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Main Chart -->
                <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                    <h3 class="font-bold text-gray-800 mb-4">Biến Động Nhập / Xuất (7 Ngày Gần Nhất)</h3>
                    <div class="relative h-80 w-full">
                        <canvas id="mainChart"></canvas>
                    </div>
                </div>

                <!-- Recent Activities -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-100">
                    <h3 class="font-bold text-gray-800 mb-4">Hoạt Động Gần Đây</h3>
                    <div class="overflow-y-auto h-80 pr-2 space-y-4" id="recent-logs">
                        <!-- Logs injected by JS -->
                    </div>
                </div>
            </div>
        </div>

        <!-- PAGE: INVENTORY -->
        <div id="page-inventory" class="page-content hidden animate-fade-in">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                <h2 class="text-2xl font-bold text-gray-800">Danh Mục Hàng Hóa</h2>
                <div class="flex gap-3 w-full md:w-auto">
                    <div class="relative flex-1 md:w-64">
                        <input type="text" id="search-product" placeholder="Tìm theo tên hoặc mã..." class="w-full pl-10 pr-4 py-2 rounded-lg border border-gray-300 focus:ring-2 focus:ring-blue-500 focus:outline-none" onkeyup="renderTable()">
                        <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                    </div>
                    <!-- Updated Button to trigger prepareAddProduct -->
                    <button onclick="prepareAddProduct()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg shadow flex items-center gap-2 whitespace-nowrap">
                        <i class="fas fa-plus"></i> Thêm Mới
                    </button>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-slate-50 text-slate-600 text-sm uppercase tracking-wider">
                                <th class="p-4 font-semibold border-b">Mã SP / QR</th>
                                <th class="p-4 font-semibold border-b">Tên Sản Phẩm</th>
                                <th class="p-4 font-semibold border-b text-right">Giá Nhập</th>
                                <th class="p-4 font-semibold border-b text-center">ĐVT</th>
                                <th class="p-4 font-semibold border-b text-right">Tồn Kho</th>
                                <th class="p-4 font-semibold border-b text-center">Trạng Thái</th>
                                <th class="p-4 font-semibold border-b text-center">Vị Trí</th>
                                <th class="p-4 font-semibold border-b text-center">Hành Động</th> <!-- NEW COLUMN -->
                            </tr>
                        </thead>
                        <tbody id="inventory-table-body" class="text-sm text-gray-700 divide-y divide-gray-100">
                            <!-- Rows injected by JS -->
                        </tbody>
                    </table>
                </div>
                <div class="p-4 border-t bg-slate-50 text-center text-sm text-gray-500" id="table-footer">
                    Hiển thị tất cả sản phẩm
                </div>
            </div>
        </div>

        <!-- PAGE: OPERATIONS (IMPORT/EXPORT) -->
        <div id="page-operations" class="page-content hidden animate-fade-in">
            <div class="max-w-4xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 text-center">Thực Hiện Giao Dịch Kho</h2>
                    <button onclick="toggleMobileModal()" class="bg-gray-800 text-white px-4 py-2 rounded-lg hover:bg-gray-700 shadow-md flex items-center gap-2">
                        <i class="fas fa-mobile-alt"></i> Mở App Quét QR
                    </button>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- IMPORT FORM -->
                    <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-blue-500">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600"><i class="fas fa-download"></i></div>
                            <h3 class="text-xl font-bold text-gray-800">Nhập Kho (Import)</h3>
                        </div>
                        <form id="form-import" onsubmit="handleTransaction(event, 'import')">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Chọn Sản Phẩm</label>
                                    <select id="import-product-select" onchange="updateStockLabel(this, 'import-stock-cnt')" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 bg-gray-50" required>
                                        <!-- Options populated by JS -->
                                    </select>
                                    <p class="text-xs mt-2 text-gray-500 flex justify-between">
                                        <span>Tồn kho thực tế:</span>
                                        <span id="import-stock-cnt" class="font-bold text-gray-800">--</span>
                                    </p>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Số Lượng</label>
                                        <input type="number" id="import-qty" min="1" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Nhà Cung Cấp</label>
                                        <input type="text" placeholder="Tên NCC" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                                    </div>
                                </div>
                                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 rounded-lg shadow mt-2 transition-transform active:scale-95">
                                    Xác Nhận Nhập Kho
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- EXPORT FORM -->
                    <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 border-green-500">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center text-green-600"><i class="fas fa-upload"></i></div>
                            <h3 class="text-xl font-bold text-gray-800">Xuất Kho (Export)</h3>
                        </div>
                        <form id="form-export" onsubmit="handleTransaction(event, 'export')">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Chọn Sản Phẩm</label>
                                    <select id="export-product-select" onchange="updateStockLabel(this, 'export-stock-cnt')" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-green-500 bg-gray-50" required>
                                        <!-- Options populated by JS -->
                                    </select>
                                    <p class="text-xs mt-2 text-gray-500 flex justify-between">
                                        <span>Tồn kho thực tế:</span>
                                        <span id="export-stock-cnt" class="font-bold text-gray-800">--</span>
                                    </p>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Số Lượng</label>
                                        <input type="number" id="export-qty" min="1" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-green-500" required>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Khách Hàng/Đơn Vị</label>
                                        <input type="text" placeholder="Tên KH" class="w-full p-2 border rounded-lg focus:ring-2 focus:ring-green-500">
                                    </div>
                                </div>
                                <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 rounded-lg shadow mt-2 transition-transform active:scale-95">
                                    Xác Nhận Xuất Kho
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- PAGE: AI & EXTENSIONS -->
        <div id="page-ai-features" class="page-content hidden animate-fade-in">
            <h2 class="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                <i class="fas fa-brain text-purple-600 mr-3"></i> AI & Đề Xuất Mở Rộng Hệ Thống
            </h2>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <!-- AI Insight Section -->
                <div>
                    <h3 class="text-lg font-bold text-gray-700 mb-4">1. Phân Tích Thông Minh (AI Insight)</h3>
                    <div class="bg-gradient-to-br from-purple-600 to-indigo-700 rounded-xl p-6 text-white shadow-lg relative overflow-hidden mb-6">
                        <i class="fas fa-robot absolute -right-6 -bottom-6 text-9xl text-white opacity-10"></i>
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="font-bold text-xl mb-2">✨ Phân Tích & Dự Báo</h4>
                                <p class="opacity-90 text-sm mb-4">Gemini sẽ phân tích toàn bộ dữ liệu kho để tìm ra rủi ro và cơ hội.</p>
                            </div>
                            <button onclick="analyzeInventoryWithGemini()" id="btn-analyze-gemini" class="bg-white text-purple-700 px-4 py-2 rounded-lg text-sm font-bold shadow hover:bg-gray-100 transition-colors flex items-center gap-2">
                                <i class="fas fa-magic"></i> Phân Tích Với Gemini
                            </button>
                        </div>
                        <div class="bg-white/10 rounded-lg p-4 backdrop-blur-sm mt-2">
                            <div id="ai-prediction-content">
                                <p class="text-sm italic opacity-80">Nhấn nút bên trên để nhận báo cáo phân tích từ AI...</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <h4 class="font-bold text-gray-800 mb-2">Gợi Ý Đặt Hàng (Cơ bản)</h4>
                        <p class="text-sm text-gray-500 mb-4">Dựa trên mức tồn kho an toàn (minStock).</p>
                        <ul class="space-y-3" id="ai-reorder-list">
                            <!-- Generated by JS -->
                        </ul>
                    </div>
                </div>

                <!-- Gemini Chat Assistant -->
                <div class="flex flex-col h-full">
                    <h3 class="text-lg font-bold text-gray-700 mb-4">2. Trợ Lý Ảo Gemini (Chatbot)</h3>
                    <div class="bg-white border border-gray-200 rounded-xl shadow-sm flex flex-col h-[500px]">
                        <div class="p-4 border-b bg-gray-50 flex items-center gap-2">
                            <div class="w-8 h-8 rounded-full bg-gradient-to-r from-blue-500 to-purple-500 flex items-center justify-center text-white"><i class="fas fa-sparkles text-xs"></i></div>
                            <div>
                                <h4 class="font-bold text-gray-800 text-sm">Hỏi Đáp Về Kho Hàng</h4>
                                <p class="text-xs text-gray-500">Được hỗ trợ bởi Google Gemini</p>
                            </div>
                        </div>
                        
                        <!-- Chat Area -->
                        <div id="chat-messages" class="flex-1 overflow-y-auto p-4 flex flex-col gap-2 bg-gray-50/50">
                            <div class="chat-bubble chat-ai">
                                Xin chào! Tôi là trợ lý AI. Tôi có thể giúp gì cho bạn về dữ liệu kho hàng hiện tại?
                                <br><span class="text-xs text-gray-400 mt-1 block">Ví dụ: "Hàng nào tồn ít nhất?", "Tổng giá trị kho?"</span>
                            </div>
                        </div>

                        <!-- Input Area -->
                        <div class="p-3 border-t bg-white rounded-b-xl">
                            <form onsubmit="handleGeminiChat(event)" class="flex gap-2">
                                <input type="text" id="chat-input" class="flex-1 border rounded-lg px-4 py-2 focus:ring-2 focus:ring-purple-500 focus:outline-none" placeholder="Nhập câu hỏi của bạn...">
                                <button type="submit" id="chat-submit-btn" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Future Modules -->
            <div>
                <h3 class="text-lg font-bold text-gray-700 mb-4">3. Các Module Mở Rộng Đề Xuất</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Mobile App -->
                    <div class="bg-white p-6 rounded-xl border border-gray-200 hover:shadow-md transition-shadow">
                        <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center text-blue-600 text-xl mb-4"><i class="fas fa-mobile-alt"></i></div>
                        <h4 class="font-bold text-gray-800">Mobile App cho Thủ Kho</h4>
                        <p class="text-sm text-gray-500 mt-2">Tích hợp camera quét mã QR/Barcode trên điện thoại để thực hiện nhập/xuất nhanh ngay tại kệ hàng mà không cần máy tính.</p>
                        <button onclick="toggleMobileModal()" class="mt-3 text-blue-600 text-sm font-semibold hover:underline">Chạy Thử Ngay &rarr;</button>
                    </div>

                    <!-- IoT Sensors -->
                    <div class="bg-white p-6 rounded-xl border border-gray-200 hover:shadow-md transition-shadow">
                        <div class="w-12 h-12 bg-orange-100 rounded-lg flex items-center justify-center text-orange-600 text-xl mb-4"><i class="fas fa-wifi"></i></div>
                        <h4 class="font-bold text-gray-800">IoT Cảm Biến Kho</h4>
                        <p class="text-sm text-gray-500 mt-2">Gắn cảm biến nhiệt độ/độ ẩm cho các kho lạnh. Tự động cảnh báo qua SMS/Zalo nếu điều kiện môi trường vượt ngưỡng.</p>
                    </div>

                    <!-- E-commerce Sync -->
                    <div class="bg-white p-6 rounded-xl border border-gray-200 hover:shadow-md transition-shadow">
                        <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center text-green-600 text-xl mb-4"><i class="fas fa-shopping-cart"></i></div>
                        <h4 class="font-bold text-gray-800">Đồng Bộ Sàn TMĐT</h4>
                        <p class="text-sm text-gray-500 mt-2">API kết nối trực tiếp với Shopee/Lazada. Khi có đơn hàng online, kho tự động trừ tồn và tạo phiếu xuất.</p>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <!-- MOBILE MOCKUP MODAL -->
    <div id="mobile-modal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-center justify-center backdrop-blur-sm p-4 animate-fade-in">
        <div class="relative w-[320px] h-[640px] phone-frame bg-gray-100 flex flex-col">
            <div class="phone-notch"></div>
            
            <!-- Phone Header -->
            <div class="bg-blue-600 text-white p-4 pt-8 flex justify-between items-center shadow-md">
                <span class="font-bold text-lg"><i class="fas fa-cube mr-2"></i>WMS Mobile</span>
                <div class="text-xs opacity-80" id="mobile-clock">09:41</div>
            </div>

            <!-- Phone Screen Content -->
            <div class="flex-1 overflow-y-auto relative" id="mobile-screen-home">
                <!-- Action Grid -->
                <div class="p-4 grid grid-cols-2 gap-4 mt-2">
                    <button onclick="switchMobileScreen('scan')" class="bg-white p-4 rounded-xl shadow-sm flex flex-col items-center justify-center gap-2 hover:bg-blue-50 transition-colors h-32">
                        <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 text-2xl"><i class="fas fa-qrcode"></i></div>
                        <span class="font-bold text-gray-700 text-sm">Quét QR</span>
                    </button>
                    <button class="bg-white p-4 rounded-xl shadow-sm flex flex-col items-center justify-center gap-2 hover:bg-green-50 transition-colors h-32 opacity-50 cursor-not-allowed">
                        <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center text-green-600 text-2xl"><i class="fas fa-search"></i></div>
                        <span class="font-bold text-gray-700 text-sm">Tìm Kiếm</span>
                    </button>
                </div>
                
                <!-- Recent Mobile Tasks -->
                <div class="px-4 mt-2">
                    <h4 class="font-bold text-gray-600 text-sm mb-2">Gần đây</h4>
                    <div class="bg-white rounded-xl p-3 shadow-sm space-y-3" id="mobile-recent-list">
                        <p class="text-xs text-center text-gray-400">Chưa có hoạt động</p>
                    </div>
                </div>
            </div>

            <!-- SCAN SCREEN -->
            <div class="absolute inset-0 top-[60px] bg-black hidden flex-col" id="mobile-screen-scan">
                <div class="flex-1 relative flex items-center justify-center overflow-hidden">
                    <!-- Fake Camera View -->
                    <div class="absolute inset-0 bg-gray-800">
                        <img src="https://images.unsplash.com/photo-1590247813693-5541d1c609fd?auto=format&fit=crop&q=80&w=400&h=800" class="w-full h-full object-cover opacity-50" alt="Warehouse Bg">
                    </div>
                    <div class="relative z-10 w-48 h-48 border-2 border-white/50 rounded-lg flex items-center justify-center">
                        <div class="absolute w-4 h-4 border-t-2 border-l-2 border-blue-500 top-0 left-0"></div>
                        <div class="absolute w-4 h-4 border-t-2 border-r-2 border-blue-500 top-0 right-0"></div>
                        <div class="absolute w-4 h-4 border-b-2 border-l-2 border-blue-500 bottom-0 left-0"></div>
                        <div class="absolute w-4 h-4 border-b-2 border-r-2 border-blue-500 bottom-0 right-0"></div>
                        <div class="scan-line"></div>
                        <p class="text-white/80 text-xs mt-24 bg-black/50 px-2 py-1 rounded">Di chuyển camera đến mã QR</p>
                    </div>
                </div>
                <div class="h-24 bg-black/80 flex items-center justify-around text-white">
                    <button onclick="switchMobileScreen('home')" class="text-gray-400 hover:text-white"><i class="fas fa-times text-xl"></i></button>
                    <button onclick="simulateScan()" class="w-16 h-16 rounded-full border-4 border-white flex items-center justify-center hover:bg-white/20 active:scale-95 transition-all">
                        <div class="w-12 h-12 bg-white rounded-full"></div>
                    </button>
                    <button class="text-gray-400 hover:text-white"><i class="fas fa-bolt text-xl"></i></button>
                </div>
            </div>

            <!-- RESULT ACTION SCREEN -->
            <div class="absolute inset-0 top-[60px] bg-slate-50 hidden flex-col p-4" id="mobile-screen-result">
                <div class="flex justify-between items-center mb-4">
                    <button onclick="switchMobileScreen('scan')" class="text-gray-500"><i class="fas fa-chevron-left"></i> Quay lại</button>
                    <span class="font-bold text-gray-800">Thông Tin SP</span>
                </div>
                
                <div class="bg-white rounded-xl p-4 shadow-sm mb-4 text-center">
                    <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 text-2xl mx-auto mb-2"><i class="fas fa-box-open"></i></div>
                    <h3 class="font-bold text-gray-900 text-lg" id="mobile-prod-name">Sản Phẩm ABC</h3>
                    <p class="text-gray-500 text-sm font-mono mb-2" id="mobile-prod-id">SP00X</p>
                    <div class="flex justify-center gap-4 text-sm">
                        <div class="bg-gray-100 px-3 py-1 rounded">Tồn: <strong id="mobile-prod-qty">0</strong></div>
                        <div class="bg-gray-100 px-3 py-1 rounded">Vị trí: <strong id="mobile-prod-loc">A-01</strong></div>
                    </div>
                </div>

                <div class="bg-white rounded-xl p-4 shadow-sm flex-1">
                    <h4 class="font-bold text-gray-700 mb-3 text-sm uppercase">Thao Tác Nhanh</h4>
                    
                    <div class="flex gap-2 mb-4">
                        <button onclick="setMobileMode('import')" class="flex-1 py-2 rounded-lg border-2 border-blue-500 text-blue-600 font-bold active-mode" id="btn-mode-import">Nhập</button>
                        <button onclick="setMobileMode('export')" class="flex-1 py-2 rounded-lg border-2 border-transparent bg-gray-100 text-gray-500 font-bold" id="btn-mode-export">Xuất</button>
                    </div>

                    <div class="mb-4">
                        <label class="block text-xs font-bold text-gray-500 mb-1">Số Lượng</label>
                        <div class="flex items-center gap-3">
                            <button onclick="adjMobileQty(-1)" class="w-10 h-10 rounded bg-gray-100 flex items-center justify-center text-xl font-bold">-</button>
                            <input type="number" id="mobile-qty-input" value="1" class="flex-1 text-center font-bold text-xl border-b-2 border-gray-200 py-1 focus:outline-none focus:border-blue-500">
                            <button onclick="adjMobileQty(1)" class="w-10 h-10 rounded bg-gray-100 flex items-center justify-center text-xl font-bold">+</button>
                        </div>
                    </div>

                    <button onclick="submitMobileTransaction()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-blue-200 active:scale-95 transition-transform" id="btn-mobile-submit">
                        Xác Nhận Nhập Kho
                    </button>
                </div>
            </div>

            <!-- Phone Footer Indicator -->
            <div class="absolute bottom-1 left-1/2 transform -translate-x-1/2 w-32 h-1 bg-gray-300 rounded-full"></div>
            
            <!-- Close Modal Button (Outside Phone) -->
            <button onclick="toggleMobileModal()" class="absolute -right-12 top-0 text-white hover:text-gray-300 text-2xl"><i class="fas fa-times"></i></button>
        </div>
    </div>

    <!-- MODAL: ADD/EDIT PRODUCT -->
    <div id="add-product-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 transform transition-all scale-100">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800" id="modal-title">Thêm Sản Phẩm Mới</h3>
                <button onclick="toggleModal('add-product-modal')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            </div>
            <!-- Updated form handler -->
            <form id="form-product" onsubmit="handleProductSubmit(event)">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Mã Sản Phẩm</label>
                        <input type="text" id="new-code" class="w-full mt-1 p-2 border rounded-lg focus:ring-2 focus:ring-blue-500 bg-white" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Tên Sản Phẩm</label>
                        <input type="text" id="new-name" class="w-full mt-1 p-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Giá Nhập</label>
                            <input type="number" id="new-price" class="w-full mt-1 p-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Số Lượng Ban Đầu</label>
                            <input type="number" id="new-qty" class="w-full mt-1 p-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Đơn Vị Tính</label>
                            <input type="text" id="new-unit" placeholder="Cái/Hộp" class="w-full mt-1 p-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Vị Trí Kho</label>
                            <input type="text" id="new-loc" placeholder="A-01" class="w-full mt-1 p-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
                        </div>
                    </div>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" onclick="toggleModal('add-product-modal')" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">Hủy</button>
                    <button type="submit" id="modal-submit-btn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow">Lưu Sản Phẩm</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="fixed bottom-4 right-4 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg transform translate-y-20 transition-transform duration-300 flex items-center gap-3 z-50">
        <i class="fas fa-check-circle text-green-400"></i>
        <span id="toast-msg">Thành công!</span>
    </div>

    <script>
        // --- 1. DATA INITIALIZATION (Simulated Database) ---
        let products = [
            { id: 'SP001', name: 'Laptop Dell Inspiron', price: 15000000, qty: 10, unit: 'Chiếc', loc: 'A-01-01', minStock: 5 },
            { id: 'SP002', name: 'Chuột Logitech M331', price: 350000, qty: 50, unit: 'Cái', loc: 'B-02-01', minStock: 20 },
            { id: 'SP003', name: 'Bàn Phím Cơ Keychron', price: 2100000, qty: 3, unit: 'Cái', loc: 'A-01-02', minStock: 5 },
            { id: 'SP004', name: 'Màn Hình LG 24inch', price: 3200000, qty: 15, unit: 'Chiếc', loc: 'C-05-01', minStock: 8 },
            { id: 'SP005', name: 'Tai Nghe Sony WH-1000XM5', price: 6500000, qty: 8, unit: 'Cái', loc: 'B-02-02', minStock: 3 }
        ];

        let transactions = []; // To store history
        let chartInstance = null;
        
        // State for Edit
        let isEditing = false;
        let editingId = null;

        // Mobile Vars
        let currentMobileProduct = null;
        let currentMobileMode = 'import';

        // --- GEMINI API CONFIG ---
        const apiKey = ""; // API Key injected by environment

        async function callGemini(prompt) {
            if(!apiKey) {
                console.warn("API Key missing");
                return "Lỗi: Chưa cấu hình API Key.";
            }
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }]
                    })
                });
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "Không nhận được phản hồi.";
            } catch (error) {
                console.error("Gemini Error:", error);
                return "Lỗi kết nối đến Gemini AI.";
            }
        }

        // --- 2. CORE FUNCTIONS ---

        // Initialize App
        document.addEventListener('DOMContentLoaded', () => {
            renderTable();
            updateDashboard();
            updateSelectOptions();
            runAISimulation();
            initChart();
            
            // Set time
            setInterval(() => {
                const now = new Date();
                const timeStr = now.toLocaleTimeString('vi-VN', {hour: '2-digit', minute:'2-digit'});
                document.getElementById('current-time').innerText = now.toLocaleTimeString('vi-VN');
                document.getElementById('mobile-clock').innerText = timeStr;
            }, 1000);
        });

        // Navigation Switcher
        function switchPage(pageId) {
            document.querySelectorAll('.page-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`page-${pageId}`).classList.remove('hidden');

            document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active'));
            const navId = `nav-${pageId}`;
            if(document.getElementById(navId)) document.getElementById(navId).classList.add('active');
        }

        // Render Inventory Table
        function renderTable() {
            const tbody = document.getElementById('inventory-table-body');
            const keyword = document.getElementById('search-product').value.toLowerCase();
            tbody.innerHTML = '';

            products.forEach(p => {
                if (p.name.toLowerCase().includes(keyword) || p.id.toLowerCase().includes(keyword)) {
                    const statusClass = p.qty <= p.minStock 
                        ? 'bg-red-100 text-red-700 border-red-200' 
                        : 'bg-green-100 text-green-700 border-green-200';
                    const statusText = p.qty <= p.minStock ? 'Sắp Hết' : 'Sẵn Sàng';

                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-gray-50 transition-colors border-b border-gray-100 group";
                    tr.innerHTML = `
                        <td class="p-4 font-mono text-gray-500 flex items-center gap-2">
                            <i class="fas fa-qrcode text-gray-300 group-hover:text-blue-500 cursor-pointer" title="In Mã QR"></i>
                            ${p.id}
                        </td>
                        <td class="p-4 font-medium text-gray-800">${p.name}</td>
                        <td class="p-4 text-right">${p.price.toLocaleString('vi-VN')} ₫</td>
                        <td class="p-4 text-center text-gray-500">${p.unit}</td>
                        <td class="p-4 text-right font-bold ${p.qty <= p.minStock ? 'text-red-600' : 'text-gray-800'}">${p.qty}</td>
                        <td class="p-4 text-center"><span class="px-2 py-1 rounded text-xs font-semibold border ${statusClass}">${statusText}</span></td>
                        <td class="p-4 text-center text-gray-500 font-mono text-xs">${p.loc}</td>
                        <td class="p-4 text-center">
                            <div class="flex justify-center gap-2">
                                <button onclick="prepareEditProduct('${p.id}')" class="text-blue-500 hover:text-blue-700 p-1.5 hover:bg-blue-50 rounded transition-colors" title="Sửa">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button onclick="deleteProduct('${p.id}')" class="text-red-500 hover:text-red-700 p-1.5 hover:bg-red-50 rounded transition-colors" title="Xóa">
                                    <i class="fas fa-trash-alt"></i>
                                </button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                }
            });
        }

        // Update Dashboard Stats
        function updateDashboard() {
            const totalValue = products.reduce((sum, p) => sum + (p.price * p.qty), 0);
            const totalQty = products.reduce((sum, p) => sum + p.qty, 0);
            const lowStockCount = products.filter(p => p.qty <= p.minStock).length;

            // Animate Numbers
            document.getElementById('kpi-value').innerText = totalValue.toLocaleString('vi-VN') + ' ₫';
            document.getElementById('kpi-qty').innerText = totalQty.toLocaleString('vi-VN');
            document.getElementById('kpi-alert').innerText = lowStockCount;
            document.getElementById('kpi-trans').innerText = transactions.length;

            updateRecentLogs();
            updateMobileRecentLogs(); // Also update mobile
            if(chartInstance) updateChartData();
        }

        // --- NEW: DELETE PRODUCT ---
        function deleteProduct(id) {
            if(confirm('Bạn có chắc chắn muốn xóa sản phẩm ' + id + ' không? Hành động này không thể hoàn tác.')) {
                products = products.filter(p => p.id !== id);
                renderTable();
                updateSelectOptions();
                updateDashboard();
                runAISimulation();
                showToast(`Đã xóa sản phẩm ${id}`);
            }
        }

        // --- NEW: EDIT PRODUCT PREP ---
        function prepareEditProduct(id) {
            const product = products.find(p => p.id === id);
            if(!product) return;

            // Set state
            isEditing = true;
            editingId = id;

            // Fill Form
            document.getElementById('new-code').value = product.id;
            document.getElementById('new-code').disabled = true; // Cannot change ID
            document.getElementById('new-code').classList.add('bg-gray-100', 'cursor-not-allowed');
            
            document.getElementById('new-name').value = product.name;
            document.getElementById('new-price').value = product.price;
            document.getElementById('new-qty').value = product.qty;
            document.getElementById('new-unit').value = product.unit;
            document.getElementById('new-loc').value = product.loc;

            // Change UI Text
            document.getElementById('modal-title').innerText = "Cập Nhật Sản Phẩm";
            document.getElementById('modal-submit-btn').innerText = "Lưu Thay Đổi";

            toggleModal('add-product-modal');
        }

        // --- NEW: ADD PRODUCT PREP ---
        function prepareAddProduct() {
            // Reset state
            isEditing = false;
            editingId = null;
            document.getElementById('form-product').reset();

            // Unlock ID field
            const codeInput = document.getElementById('new-code');
            codeInput.disabled = false;
            codeInput.classList.remove('bg-gray-100', 'cursor-not-allowed');

            // Reset UI Text
            document.getElementById('modal-title').innerText = "Thêm Sản Phẩm Mới";
            document.getElementById('modal-submit-btn').innerText = "Lưu Sản Phẩm";

            toggleModal('add-product-modal');
        }

        // --- MODIFIED: HANDLE FORM SUBMIT (ADD OR EDIT) ---
        function handleProductSubmit(e) {
            e.preventDefault();
            
            const formData = {
                id: document.getElementById('new-code').value.toUpperCase(),
                name: document.getElementById('new-name').value,
                price: parseInt(document.getElementById('new-price').value),
                qty: parseInt(document.getElementById('new-qty').value),
                unit: document.getElementById('new-unit').value,
                loc: document.getElementById('new-loc').value,
                minStock: 5 
            };

            if (isEditing) {
                // Update Logic
                const index = products.findIndex(p => p.id === editingId);
                if(index !== -1) {
                    products[index] = { ...formData, minStock: products[index].minStock }; // Keep minStock
                    showToast(`Đã cập nhật: ${formData.name}`);
                }
            } else {
                // Add Logic
                if(products.find(p => p.id === formData.id)) {
                    alert("Mã sản phẩm đã tồn tại!");
                    return;
                }
                products.unshift(formData);
                showToast(`Đã thêm mới: ${formData.name}`);
            }

            renderTable();
            updateSelectOptions();
            updateDashboard();
            runAISimulation();
            toggleModal('add-product-modal');
        }

        // Transaction Logic (Import/Export)
        function handleTransaction(e, type) {
            e.preventDefault();
            const id = type === 'import' ? document.getElementById('import-product-select').value : document.getElementById('export-product-select').value;
            const qty = parseInt(type === 'import' ? document.getElementById('import-qty').value : document.getElementById('export-qty').value);
            
            processTransaction(id, qty, type);
            e.target.reset();
        }

        // Shared Transaction Processor
        function processTransaction(id, qty, type) {
            const product = products.find(p => p.id === id);
            if (!product) return;

            if (type === 'export' && product.qty < qty) {
                alert("Lỗi: Số lượng tồn kho không đủ để xuất!");
                return;
            }

            if (type === 'import') {
                product.qty += qty;
            } else {
                product.qty -= qty;
            }

            const log = {
                time: new Date(),
                type: type,
                prodName: product.name,
                qty: qty
            };
            transactions.unshift(log);

            renderTable();
            updateDashboard();
            updateSelectOptions(); // Force update select options to reflect new stock
            showToast(`${type === 'import' ? 'Nhập' : 'Xuất'} thành công ${qty} ${product.unit} ${product.name}`);
        }

        // Helper: Populate Select Dropdowns
        function updateSelectOptions() {
            const opts = products.map(p => `<option value="${p.id}">${p.id} - ${p.name} (Tồn: ${p.qty})</option>`).join('');
            const importSelect = document.getElementById('import-product-select');
            const exportSelect = document.getElementById('export-product-select');
            
            importSelect.innerHTML = opts;
            exportSelect.innerHTML = opts;
            
            // Also update the static labels immediately based on current selection (or first item)
            updateStockLabel(importSelect, 'import-stock-cnt');
            updateStockLabel(exportSelect, 'export-stock-cnt');
        }
        
        // Helper: Update Stock Label below Select
        function updateStockLabel(select, displayId) {
            const product = products.find(p => p.id === select.value);
            const el = document.getElementById(displayId);
            if(product && el) {
                el.innerText = `${product.qty} ${product.unit}`;
                if(product.qty <= product.minStock) {
                    el.className = "font-bold text-red-600";
                    el.innerText += " (Sắp hết)";
                } else {
                    el.className = "font-bold text-gray-800";
                }
            } else if (el) {
                el.innerText = "--";
            }
        }

        // Helper: Toggle Modal
        function toggleModal(id) {
            const el = document.getElementById(id);
            el.classList.toggle('hidden');
        }

        // Helper: Show Toast
        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            t.classList.remove('translate-y-20');
            setTimeout(() => t.classList.add('translate-y-20'), 3000);
        }

        // Helper: Recent Logs Render
        function updateRecentLogs() {
            const container = document.getElementById('recent-logs');
            if (transactions.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-400 text-sm mt-4">Chưa có giao dịch nào.</p>';
                return;
            }
            container.innerHTML = transactions.slice(0, 10).map(t => {
                const icon = t.type === 'import' ? '<i class="fas fa-arrow-down text-blue-500"></i>' : '<i class="fas fa-arrow-up text-green-500"></i>';
                const color = t.type === 'import' ? 'bg-blue-50' : 'bg-green-50';
                return `
                    <div class="flex items-center gap-3 p-3 rounded-lg ${color} border border-opacity-50 border-gray-200">
                        <div class="w-8 h-8 bg-white rounded-full flex items-center justify-center shadow-sm">${icon}</div>
                        <div class="flex-1">
                            <p class="text-sm font-bold text-gray-800">${t.type === 'import' ? 'Nhập kho' : 'Xuất kho'}: ${t.prodName}</p>
                            <p class="text-xs text-gray-500">${t.time.toLocaleTimeString('vi-VN')} - Số lượng: <strong>${t.qty}</strong></p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // --- 3. MOBILE APP SIMULATION LOGIC ---

        function toggleMobileModal() {
            const el = document.getElementById('mobile-modal');
            el.classList.toggle('hidden');
            if (!el.classList.contains('hidden')) {
                switchMobileScreen('home');
            }
        }

        function switchMobileScreen(screenName) {
            ['home', 'scan', 'result'].forEach(s => {
                document.getElementById(`mobile-screen-${s}`).classList.add('hidden');
                document.getElementById(`mobile-screen-${s}`).classList.remove('flex');
            });
            const target = document.getElementById(`mobile-screen-${screenName}`);
            target.classList.remove('hidden');
            target.classList.add('flex');
        }

        function simulateScan() {
            // Pick a random product to simulate a QR scan
            const randIndex = Math.floor(Math.random() * products.length);
            currentMobileProduct = products[randIndex];
            
            // Show scanning delay
            const btn = event.currentTarget;
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin text-blue-500"></i>';
            
            setTimeout(() => {
                btn.innerHTML = '<div class="w-12 h-12 bg-white rounded-full"></div>'; // Reset button
                
                // Populate Result Screen
                document.getElementById('mobile-prod-name').innerText = currentMobileProduct.name;
                document.getElementById('mobile-prod-id').innerText = currentMobileProduct.id;
                document.getElementById('mobile-prod-qty').innerText = currentMobileProduct.qty;
                document.getElementById('mobile-prod-loc').innerText = currentMobileProduct.loc;
                
                // Reset form
                document.getElementById('mobile-qty-input').value = 1;
                setMobileMode('import'); // Default
                
                switchMobileScreen('result');
            }, 1000);
        }

        function setMobileMode(mode) {
            currentMobileMode = mode;
            const btnImport = document.getElementById('btn-mode-import');
            const btnExport = document.getElementById('btn-mode-export');
            const btnSubmit = document.getElementById('btn-mobile-submit');

            if(mode === 'import') {
                btnImport.className = "flex-1 py-2 rounded-lg border-2 border-blue-500 bg-blue-50 text-blue-600 font-bold";
                btnExport.className = "flex-1 py-2 rounded-lg border-2 border-transparent bg-gray-100 text-gray-500 font-bold";
                btnSubmit.className = "w-full bg-blue-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-blue-200 active:scale-95 transition-transform";
                btnSubmit.innerText = "Xác Nhận Nhập Kho";
            } else {
                btnExport.className = "flex-1 py-2 rounded-lg border-2 border-green-500 bg-green-50 text-green-600 font-bold";
                btnImport.className = "flex-1 py-2 rounded-lg border-2 border-transparent bg-gray-100 text-gray-500 font-bold";
                btnSubmit.className = "w-full bg-green-600 text-white py-3 rounded-xl font-bold shadow-lg shadow-green-200 active:scale-95 transition-transform";
                btnSubmit.innerText = "Xác Nhận Xuất Kho";
            }
        }

        function adjMobileQty(delta) {
            const input = document.getElementById('mobile-qty-input');
            let val = parseInt(input.value) + delta;
            if(val < 1) val = 1;
            input.value = val;
        }

        function submitMobileTransaction() {
            if(!currentMobileProduct) return;
            const qty = parseInt(document.getElementById('mobile-qty-input').value);
            
            processTransaction(currentMobileProduct.id, qty, currentMobileMode);
            
            // Go back to home after success
            switchMobileScreen('home');
        }

        function updateMobileRecentLogs() {
            const container = document.getElementById('mobile-recent-list');
            if (transactions.length === 0) {
                container.innerHTML = '<p class="text-xs text-center text-gray-400">Chưa có hoạt động</p>';
                return;
            }
            container.innerHTML = transactions.slice(0, 3).map(t => {
                const color = t.type === 'import' ? 'text-blue-600' : 'text-green-600';
                const label = t.type === 'import' ? 'Nhập' : 'Xuất';
                return `
                    <div class="flex justify-between items-center text-xs border-b border-gray-100 last:border-0 pb-2 last:pb-0">
                        <div>
                            <span class="font-bold text-gray-700">${t.prodName}</span>
                            <div class="text-gray-400">${t.time.toLocaleTimeString('vi-VN', {hour:'2-digit', minute:'2-digit'})}</div>
                        </div>
                        <div class="font-bold ${color}">${label} ${t.qty}</div>
                    </div>
                `;
            }).join('');
        }

        // --- 4. AI & CHARTS LOGIC ---
        
        // Existing "simulated" logic remains for basic reorder list
        function runAISimulation() {
            const reorderList = document.getElementById('ai-reorder-list');
            const lowStock = products.filter(p => p.qty <= p.minStock);
            
            if (lowStock.length > 0) {
                reorderList.innerHTML = lowStock.map(p => `
                    <li class="flex justify-between items-center border-b pb-2">
                        <span>${p.name}</span>
                        <span class="text-xs bg-red-100 text-red-600 px-2 py-1 rounded">Cần nhập thêm ${p.minStock * 2} ${p.unit}</span>
                    </li>
                `).join('');
            } else {
                reorderList.innerHTML = '<li class="text-sm text-gray-400">Không có đề xuất nhập hàng (Dựa trên MinStock).</li>';
            }
        }

        // --- GEMINI FUNCTIONS ---

        async function analyzeInventoryWithGemini() {
            const contentDiv = document.getElementById('ai-prediction-content');
            const btn = document.getElementById('btn-analyze-gemini');
            
            contentDiv.innerHTML = '<p class="text-sm animate-pulse"><i class="fas fa-spinner fa-spin"></i> Gemini đang phân tích dữ liệu kho...</p>';
            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');

            const inventoryData = JSON.stringify(products.map(p => ({
                name: p.name,
                qty: p.qty,
                price: p.price,
                min: p.minStock
            })));

            const prompt = `Bạn là chuyên gia quản lý kho. Dưới đây là dữ liệu tồn kho JSON: ${inventoryData}. Hãy phân tích ngắn gọn trong 3 gạch đầu dòng bằng tiếng Việt: 1. Rủi ro hết hàng (nêu tên SP). 2. Giá trị tồn kho (có sản phẩm nào giá trị quá cao đang tồn nhiều không?). 3. Đề xuất hành động ngay lập tức. Giữ giọng văn chuyên nghiệp.`;

            const result = await callGemini(prompt);
            
            // Simple markdown parsing for bold text
            const formattedResult = result.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');

            contentDiv.innerHTML = `<div class="text-sm space-y-2">${formattedResult}</div>`;
            btn.disabled = false;
            btn.classList.remove('opacity-50', 'cursor-not-allowed');
        }

        async function handleGeminiChat(e) {
            e.preventDefault();
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            if(!message) return;

            // Add user message
            const chatContainer = document.getElementById('chat-messages');
            chatContainer.innerHTML += `<div class="chat-bubble chat-user">${message}</div>`;
            input.value = '';
            chatContainer.scrollTop = chatContainer.scrollHeight;

            // Add loading
            const loadingId = 'loading-' + Date.now();
            chatContainer.innerHTML += `<div id="${loadingId}" class="chat-bubble chat-ai"><i class="fas fa-circle-notch fa-spin"></i></div>`;
            chatContainer.scrollTop = chatContainer.scrollHeight;

            // Prepare Context
            const inventoryContext = JSON.stringify(products);
            const systemPrompt = `Bạn là trợ lý ảo WMS. Dữ liệu kho hiện tại: ${inventoryContext}. Người dùng hỏi: "${message}". Hãy trả lời ngắn gọn, thân thiện bằng tiếng Việt dựa trên dữ liệu trên. Nếu không tìm thấy, hãy nói không có thông tin.`;

            // Call API
            const reply = await callGemini(systemPrompt);
            
            // Remove loading and add reply
            document.getElementById(loadingId).remove();
            chatContainer.innerHTML += `<div class="chat-bubble chat-ai">${reply}</div>`;
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function initChart() {
            const ctx = document.getElementById('mainChart').getContext('2d');
            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'CN'],
                    datasets: [
                        {
                            label: 'Nhập (Mẫu)',
                            data: [5, 12, 3, 5, 2, 3, 9], 
                            backgroundColor: '#3B82F6',
                            borderRadius: 4
                        },
                        {
                            label: 'Xuất (Mẫu)',
                            data: [8, 5, 12, 4, 8, 2, 5], 
                            backgroundColor: '#10B981',
                            borderRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } },
                    scales: { y: { beginAtZero: true, grid: { borderDash: [2, 2] } }, x: { grid: { display: false } } }
                }
            });
        }

        function updateChartData() {
            if(chartInstance) {
                const newData = chartInstance.data.datasets[1].data.map(val => val + Math.floor(Math.random() * 3)); 
                chartInstance.update();
            }
        }

        function refreshData() {
            const btn = document.querySelector('.fa-sync-alt');
            btn.classList.add('fa-spin');
            setTimeout(() => {
                btn.classList.remove('fa-spin');
                showToast("Đã đồng bộ dữ liệu mới nhất!");
                runAISimulation(); 
            }, 800);
        }

    </script>
</body>
</html>